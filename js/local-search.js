window.addEventListener("DOMContentLoaded",()=>{let e,t=!1,n=!0,r=CONFIG.path;0===r.length?r="search.xml":r.endsWith("json")&&(n=!1);const o=document.querySelector(".search-input"),l=document.getElementById("search-result"),s=(e,t,n)=>{let r=e.length;if(0===r)return[];let o=0,l=[],s=[];for(n||(t=t.toLowerCase(),e=e.toLowerCase());(l=t.indexOf(e,o))>-1;)s.push({position:l,word:e}),o=l+r;return s},a=(e,t,n,r)=>{let o=n[n.length-1],{position:l,word:s}=o,a=[],c=0;for(;l+s.length<=t&&0!==n.length;){s===r&&c++,a.push({position:l,length:s.length});let e=l+s.length;for(n.pop();0!==n.length&&(l=(o=n[n.length-1]).position,s=o.word,e>l);)n.pop()}return{hits:a,start:e,end:t,searchTextCount:c}},c=(e,t)=>{let n="",r=t.start;return t.hits.forEach(t=>{n+=e.substring(r,t.position);let o=t.position+t.length;n+=`<b class="search-keyword">${e.substring(t.position,o)}</b>`,r=o}),n+=e.substring(r,t.end)},i=()=>{if(!t)return;let n=o.value.trim().toLowerCase(),r=n.split(/[-\s]+/);r.length>1&&r.push(n);let i=[];if(n.length>0&&e.forEach(({title:e,content:t,url:o})=>{let l=e.toLowerCase(),h=t.toLowerCase(),u=[],d=[],p=0;if(r.forEach(e=>{u=u.concat(s(e,l,!1)),d=d.concat(s(e,h,!1))}),u.length>0||d.length>0){let r=u.length+d.length;[u,d].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)});let l=[];if(0!==u.length){let t=a(0,e.length,u,n);p+=t.searchTextCountInSlice,l.push(t)}let s=[];for(;0!==d.length;){let e=d[d.length-1],{position:r,word:o}=e,l=r-20,c=r+80;l<0&&(l=0),c<r+o.length&&(c=r+o.length),c>t.length&&(c=t.length);let i=a(l,c,d,n);p+=i.searchTextCountInSlice,s.push(i)}s.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);let h=parseInt(CONFIG.localsearch.top_n_per_article,10);h>=0&&(s=s.slice(0,h));let g="";0!==l.length?g+=`<li><a href="${o}" class="search-result-title">${c(e,l[0])}</a>`:g+=`<li><a href="${o}" class="search-result-title">${e}</a>`,s.forEach(e=>{g+=`<a href="${o}"><p class="search-result">${c(t,e)}...</p></a>`}),g+="</li>",i.push({item:g,id:i.length,hitCount:r,searchTextCount:p})}}),1===r.length&&""===r[0])l.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===i.length)l.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{i.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let e='<ul class="search-result-list">';i.forEach(t=>{e+=t.item}),e+="</ul>",l.innerHTML=e,window.pjax&&window.pjax.refresh(l)}},h=()=>{fetch("https://cdn.jsdelivr.net/gh/hqweay/hqweay.github.io@master/"+r).then(e=>e.text()).then(r=>{t=!0,e=(e=n?[...(new DOMParser).parseFromString(r,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(r)).filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",CONFIG.localsearch.unescape&&(e.content=(e=>String(e).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x3A;/g,":").replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(t)).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"))(e.content)),e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),document.getElementById("no-result").innerHTML='<i class="fa fa-search fa-5x"></i>'})};CONFIG.localsearch.preload&&h(),"auto"===CONFIG.localsearch.trigger?o.addEventListener("input",i):(document.querySelector(".search-icon").addEventListener("click",i),o.addEventListener("keypress",e=>{"Enter"===e.key&&i()})),document.querySelectorAll(".popup-trigger").forEach(e=>{e.addEventListener("click",()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").style.display="block",o.focus(),t||h()})});const u=()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").style.display=""};document.querySelector(".search-pop-overlay").addEventListener("click",e=>{e.target===document.querySelector(".search-pop-overlay")&&u()}),document.querySelector(".popup-btn-close").addEventListener("click",u),window.addEventListener("pjax:success",u),window.addEventListener("keyup",e=>{"Escape"===e.key&&u()})});